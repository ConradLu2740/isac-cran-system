# 分布式微服务架构设计

## 一、架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        API网关                         │
│                    统一入口、路由、限流、鉴权                      │
└─────────────────────────────────────────────────────────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  IRS服务     │ │  算法服务    │ │  传感器服务  │ │  信道服务    │
│  :8001      │ │  :8002      │ │  :8003      │ │  :8004      │
│             │ │             │ │             │ │             │
│ - 状态查询   │ │ - 波束成形   │ │ - 数据采集   │ │ - 信道模拟   │
│ - 相移配置   │ │ - DOA估计    │ │ - 数据存储   │ │ - 信道估计   │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
         │              │              │              │
         └──────────────┴──────────────┴──────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    消息队列                         │
│                    异步任务处理、服务解耦                          │
└─────────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   Consul    │ │   MySQL     │ │  InfluxDB   │
│  服务发现    │ │  配置数据    │ │  时序数据    │
└─────────────┘ └─────────────┘ └─────────────┘
```

## 二、服务拆分

| 服务名 | 端口 | 职责 | 依赖 |
|--------|------|------|------|
| API网关 | 8080 | 统一入口、路由 | 所有服务 |
| IRS服务 | 8001 | IRS状态、配置 | MySQL |
| 算法服务 | 8002 | 波束成形、DOA | MySQL、InfluxDB |
| 传感器服务 | 8003 | 数据采集、存储 | InfluxDB |
| 信道服务 | 8004 | 信道模拟、估计 | InfluxDB |

## 三、通信方式

| 场景 | 方式 | 说明 |
|------|------|------|
| 同步调用 | gRPC | 服务间实时通信 |
| 异步任务 | RabbitMQ | 算法任务、数据处理 |
| 事件通知 | RabbitMQ | 状态变更、告警 |

## 四、服务发现

使用Consul实现服务注册与发现：

```go
// 服务注册
service := &consul.AgentServiceRegistration{
    Name: "irs-service",
    Port: 8001,
    Check: &consul.AgentServiceCheck{
        HTTP:     "http://localhost:8001/health",
        Interval: "10s",
    },
}
consulClient.Agent().ServiceRegister(service)
```

## 五、消息队列

RabbitMQ队列设计：

| 队列名 | 生产者 | 消费者 | 用途 |
|--------|--------|--------|------|
| algorithm.beamforming | API网关 | 算法服务 | 波束成形任务 |
| algorithm.doa | API网关 | 算法服务 | DOA估计任务 |
| sensor.data | 传感器服务 | 信道服务 | 传感器数据 |
| notification.alert | 所有服务 | 通知服务 | 告警通知 |
