# 系统架构设计文档

## 1. 系统概述

ISAC-CRAN系统是一个智能反射面辅助C-RAN通信感知一体化实验原型系统，采用分层架构设计，支持设备模拟、算法运行、数据存储和API服务。

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端应用层 (React)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API服务层 (Gin)                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │   IRS控制API  │ │  信道数据API  │ │  算法运行API  │ │ 物联网数据API │       │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  中间件: 鉴权 | 限流 | 日志 | 异常恢复 | CORS | 请求追踪              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          业务逻辑层 (Service)                                │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │ IRS配置服务   │ │ 信道处理服务  │ │ 算法引擎服务  │ │ 数据分析服务  │       │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        设备控制层 / 算法引擎层                                │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │ IRS模拟器/驱动│ │USRP模拟器/驱动│ │ 传感器模拟器  │ │ MATLAB接口   │       │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  算法模块: 波束成形优化 | DOA估计 | 资源调度 | 无速率编码              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据存储层                                         │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │   InfluxDB    │ │    MySQL     │ │    Redis     │ │  文件存储     │       │
│  │ (时序数据)    │ │ (配置数据)   │ │ (缓存/队列)  │ │(MATLAB交换)  │       │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

| 模块 | 职责 |
|------|------|
| Handler | HTTP请求处理，参数校验，响应封装 |
| Service | 业务逻辑处理，事务管理 |
| Device | 设备驱动对接，模拟器实现 |
| Algorithm | 算法实现，优化计算 |
| Repository | 数据访问，CRUD操作 |
| Model | 数据结构定义 |
| Middleware | 请求拦截，通用处理 |

## 3. 数据流

### 3.1 IRS控制流程

```
用户请求 → Handler → Service → Device(IRS Controller) → 模拟器/硬件
                                              ↓
                                        状态更新
                                              ↓
                                    Repository → 数据库
```

### 3.2 算法运行流程

```
用户请求 → Handler → Service → Algorithm Engine
                              ↓
                        算法计算
                              ↓
                        结果存储 → Repository → 数据库
                              ↓
                        MATLAB导出 → 文件系统
```

## 4. 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| Web框架 | Gin | 高性能，轻量级，中间件丰富 |
| ORM | GORM | Go最流行的ORM，功能完善 |
| 时序数据库 | InfluxDB | 专为时序数据设计，高性能 |
| 关系数据库 | MySQL | 成熟稳定，生态完善 |
| 缓存 | Redis | 高性能，支持多种数据结构 |
| 日志 | Zap | 高性能结构化日志 |
| 配置 | Viper | 支持多种格式，热更新 |

## 5. 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Compose                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Server    │  │    MySQL    │  │  InfluxDB   │         │
│  │   :8080     │  │   :3307     │  │   :8086     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │    Redis    │  │    MQTT     │                           │
│  │   :6379     │  │   :1883     │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

## 6. 扩展性设计

### 6.1 设备驱动扩展

系统采用接口设计，支持通过实现Driver接口来添加新的设备驱动：

```go
type Driver interface {
    Connect(ctx context.Context) error
    Disconnect() error
    IsConnected() bool
}
```

### 6.2 算法扩展

算法模块独立设计，可以方便地添加新的算法实现：

```go
type Algorithm interface {
    Execute(params interface{}) (result interface{}, error)
}
```

### 6.3 存储扩展

Repository接口设计支持切换不同的存储后端：

```go
type Repository interface {
    Create(ctx context.Context, entity interface{}) error
    Get(ctx context.Context, id interface{}) (interface{}, error)
    List(ctx context.Context, query interface{}) ([]interface{}, error)
    Update(ctx context.Context, entity interface{}) error
    Delete(ctx context.Context, id interface{}) error
}
```
