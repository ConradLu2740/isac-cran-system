<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISAC-CRAN å®éªŒåŸå‹ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; }
        .layout { display: flex; min-height: 100vh; }
        .sider { width: 200px; background: #001529; color: #fff; }
        .sider-header { height: 64px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu { list-style: none; padding: 16px 0; }
        .menu-item { padding: 12px 24px; cursor: pointer; transition: all 0.3s; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.active { background: #1890ff; }
        .main { flex: 1; }
        .header { height: 64px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .content { padding: 24px; }
        .card { background: #fff; border-radius: 8px; padding: 24px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
        .row { display: flex; gap: 16px; margin-bottom: 16px; }
        .col { flex: 1; }
        .stat { text-align: center; padding: 16px; }
        .stat-title { font-size: 14px; color: #666; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 600; color: #333; }
        .stat-suffix { font-size: 14px; color: #666; margin-left: 4px; }
        .btn { padding: 8px 16px; background: #1890ff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #40a9ff; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #52c41a; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .table th { background: #fafafa; font-weight: 600; }
        .result-box { background: #f6f8fa; padding: 16px; border-radius: 4px; margin-top: 16px; }
        .result-item { display: flex; margin-bottom: 8px; }
        .result-label { width: 120px; color: #666; }
        .result-value { flex: 1; font-weight: 500; }
        .chart-container { height: 300px; }
        .hidden { display: none; }
        .status-online { color: #52c41a; }
        .status-offline { color: #ff4d4f; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="sider">
            <div class="sider-header">ISAC-CRAN</div>
            <ul class="menu">
                <li class="menu-item active" onclick="showPage('dashboard')">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</li>
                <li class="menu-item" onclick="showPage('irs')">ğŸ“¡ IRSæ§åˆ¶</li>
                <li class="menu-item" onclick="showPage('algorithm')">ğŸ”¬ ç®—æ³•å¼•æ“</li>
                <li class="menu-item" onclick="showPage('sensor')">ğŸŒ¡ï¸ ä¼ æ„Ÿå™¨</li>
                <li class="menu-item" onclick="showPage('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</li>
            </ul>
        </div>
        <div class="main">
            <div class="header">
                <h2>ISAC-CRAN å®éªŒåŸå‹ç³»ç»Ÿ</h2>
                <span id="currentTime"></span>
            </div>
            <div class="content">
                <!-- Dashboard Page -->
                <div id="page-dashboard">
                    <div class="row">
                        <div class="col"><div class="card"><div class="stat"><div class="stat-title">IRSé˜µå…ƒæ•°é‡</div><div class="stat-value"><span id="stat-elements">64</span><span class="stat-suffix">ä¸ª</span></div></div></div></div>
                        <div class="col"><div class="card"><div class="stat"><div class="stat-title">å·¥ä½œé¢‘ç‡</div><div class="stat-value">2.4<span class="stat-suffix">GHz</span></div></div></div></div>
                        <div class="col"><div class="card"><div class="stat"><div class="stat-title">ä¼ æ„Ÿå™¨æ•°é‡</div><div class="stat-value"><span id="stat-sensors">8</span><span class="stat-suffix">ä¸ª</span></div></div></div></div>
                        <div class="col"><div class="card"><div class="stat"><div class="stat-title">ç³»ç»ŸçŠ¶æ€</div><div class="stat-value" style="color: #52c41a;">æ­£å¸¸è¿è¡Œ</div></div></div></div>
                    </div>
                    <div class="row">
                        <div class="col"><div class="card"><div class="card-title">æ³¢æŸæ–¹å‘å›¾</div><div id="chart-beam" class="chart-container"></div></div></div>
                        <div class="col"><div class="card"><div class="card-title">ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿</div><div id="chart-sensor" class="chart-container"></div></div></div>
                    </div>
                </div>

                <!-- IRS Page -->
                <div id="page-irs" class="hidden">
                    <div class="card">
                        <div class="card-title">IRSæ§åˆ¶é¢æ¿ <button class="btn" onclick="fetchIRSStatus()" style="float: right;">åˆ·æ–°çŠ¶æ€</button></div>
                        <div class="row">
                            <div class="col"><div class="stat"><div class="stat-title">é˜µå…ƒæ•°é‡</div><div class="stat-value" id="irs-elements">64</div></div></div>
                            <div class="col"><div class="stat"><div class="stat-title">é¢‘æ®µ</div><div class="stat-value" id="irs-freq">2.4GHz</div></div></div>
                            <div class="col"><div class="stat"><div class="stat-title">æ¸©åº¦</div><div class="stat-value"><span id="irs-temp">29.4</span><span class="stat-suffix">Â°C</span></div></div></div>
                            <div class="col"><div class="stat"><div class="stat-title">ç”µæºçŠ¶æ€</div><div class="stat-value" id="irs-power" style="color: #52c41a;">æ­£å¸¸</div></div></div>
                        </div>
                        <div class="result-box">
                            <div class="result-item"><div class="result-label">ç›¸ç§»é…ç½® (å‰16ä¸ª):</div><div class="result-value" id="irs-phases">0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00</div></div>
                        </div>
                    </div>
                </div>

                <!-- Algorithm Page -->
                <div id="page-algorithm" class="hidden">
                    <div class="card">
                        <div class="card-title">ç®—æ³•å¼•æ“</div>
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin-bottom: 12px;">æ³¢æŸæˆå½¢ç®—æ³•</h4>
                            <p style="color: #666; margin-bottom: 12px;">é€šè¿‡è°ƒæ•´IRSé˜µå…ƒçš„ç›¸ç§»ï¼Œå®ç°ä¿¡å·åœ¨ç›®æ ‡æ–¹å‘çš„å¢ç›Šæœ€å¤§åŒ–ã€‚</p>
                            <button class="btn" id="btn-beamforming" onclick="runBeamforming()">è¿è¡Œæ³¢æŸæˆå½¢ç®—æ³•</button>
                            <div id="beamforming-result" class="result-box hidden">
                                <div class="row">
                                    <div class="col"><div id="chart-beam-result" class="chart-container"></div></div>
                                    <div class="col">
                                        <div class="result-item"><div class="result-label">è¿­ä»£æ¬¡æ•°:</div><div class="result-value" id="bf-iterations">-</div></div>
                                        <div class="result-item"><div class="result-label">æ˜¯å¦æ”¶æ•›:</div><div class="result-value" id="bf-converged">-</div></div>
                                        <div class="result-item"><div class="result-label">ä¸»ç“£æ–¹å‘:</div><div class="result-value" id="bf-mainlobe">-</div></div>
                                        <div class="result-item"><div class="result-label">å‰¯ç“£ç”µå¹³:</div><div class="result-value" id="bf-sll">-</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr style="border: none; border-top: 1px solid #f0f0f0; margin: 24px 0;">
                        <div>
                            <h4 style="margin-bottom: 12px;">DOAä¼°è®¡ç®—æ³•</h4>
                            <p style="color: #666; margin-bottom: 12px;">ä½¿ç”¨MUSICç®—æ³•ä¼°è®¡ä¿¡å·æºçš„åˆ°è¾¾æ–¹å‘ã€‚</p>
                            <button class="btn" id="btn-doa" onclick="runDOA()">è¿è¡ŒDOAä¼°è®¡ç®—æ³•</button>
                            <div id="doa-result" class="result-box hidden">
                                <div class="row">
                                    <div class="col"><div id="chart-doa-result" class="chart-container"></div></div>
                                    <div class="col">
                                        <div class="result-item"><div class="result-label">ä¼°è®¡è§’åº¦:</div><div class="result-value" id="doa-angles">-</div></div>
                                        <div class="result-item"><div class="result-label">è°±ç‚¹æ•°é‡:</div><div class="result-value" id="doa-spectrum">-</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sensor Page -->
                <div id="page-sensor" class="hidden">
                    <div class="card">
                        <div class="card-title">ä¼ æ„Ÿå™¨åˆ—è¡¨</div>
                        <table class="table">
                            <thead><tr><th>ä¼ æ„Ÿå™¨ID</th><th>ç±»å‹</th><th>ä½ç½®</th><th>å•ä½</th><th>çŠ¶æ€</th></tr></thead>
                            <tbody id="sensor-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="page-settings" class="hidden">
                    <div class="card">
                        <div class="card-title">ç³»ç»Ÿè®¾ç½®</div>
                        <div class="result-item"><div class="result-label">ç³»ç»Ÿç‰ˆæœ¬:</div><div class="result-value">1.0.0</div></div>
                        <div class="result-item"><div class="result-label">ç³»ç»Ÿåç§°:</div><div class="result-value">ISAC-CRAN System</div></div>
                        <div class="result-item"><div class="result-label">æè¿°:</div><div class="result-value">æ™ºèƒ½åå°„é¢è¾…åŠ©C-RANé€šä¿¡æ„ŸçŸ¥ä¸€ä½“åŒ–å®éªŒåŸå‹ç³»ç»Ÿ</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        let beamChart, sensorChart, beamResultChart, doaResultChart;

        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        function showPage(page) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + page).classList.remove('hidden');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function fetchIRSStatus() {
            try {
                const res = await axios.get(`${API_BASE}/irs/status`);
                const data = res.data.data;
                document.getElementById('irs-elements').textContent = data.element_count || 64;
                document.getElementById('irs-freq').textContent = data.frequency_band || '2.4GHz';
                document.getElementById('irs-temp').textContent = (data.temperature || 29.4).toFixed(1);
                document.getElementById('irs-power').textContent = data.power_status ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                document.getElementById('irs-power').style.color = data.power_status ? '#52c41a' : '#ff4d4f';
                if (data.phase_shifts && data.phase_shifts.length > 0) {
                    document.getElementById('irs-phases').textContent = data.phase_shifts.slice(0, 16).map(p => p.toFixed(2)).join(', ');
                }
            } catch (e) { console.error(e); }
        }

        async function fetchSensors() {
            try {
                const res = await axios.get(`${API_BASE}/sensor/list`);
                const sensors = res.data.data || [];
                document.getElementById('stat-sensors').textContent = sensors.length;
                const tbody = document.getElementById('sensor-table');
                tbody.innerHTML = sensors.map(s => `<tr>
                    <td>${s.sensor_id}</td><td>${s.sensor_type}</td><td>${s.location}</td>
                    <td>${s.unit}</td><td class="${s.status === 1 ? 'status-online' : 'status-offline'}">${s.status === 1 ? 'åœ¨çº¿' : 'ç¦»çº¿'}</td>
                </tr>`).join('');
            } catch (e) { console.error(e); }
        }

        async function runBeamforming() {
            const btn = document.getElementById('btn-beamforming');
            btn.disabled = true; btn.textContent = 'è¿è¡Œä¸­...';
            try {
                const res = await axios.post(`${API_BASE}/algorithm/beamforming`, {
                    experiment_id: `exp_${Date.now()}`,
                    params: { element_count: 64, target_direction: 0.5, interference_angles: [0.2, 0.8], snr_threshold: 0.9, max_iterations: 100 }
                });
                const data = res.data.data;
                document.getElementById('bf-iterations').textContent = data.iterations || '-';
                document.getElementById('bf-converged').textContent = data.converged ? 'æ˜¯' : 'å¦';
                document.getElementById('bf-mainlobe').textContent = data.main_lobe_direction?.toFixed(4) || '-';
                document.getElementById('bf-sll').textContent = (data.side_lobe_level?.toFixed(4) || '-') + ' dB';
                document.getElementById('beamforming-result').classList.remove('hidden');
                if (data.beam_pattern) {
                    const angles = data.beam_pattern.map((_, i) => Math.floor(i * 360 / data.beam_pattern.length));
                    beamResultChart.setOption({
                        title: { text: 'æ³¢æŸæ–¹å‘å›¾', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: angles, name: 'è§’åº¦ (Â°)' },
                        yAxis: { type: 'value', name: 'å¢ç›Š' },
                        series: [{ type: 'line', data: data.beam_pattern, smooth: true, areaStyle: { opacity: 0.3 } }]
                    });
                }
                alert('æ³¢æŸæˆå½¢ç®—æ³•è¿è¡ŒæˆåŠŸï¼');
            } catch (e) { alert('ç®—æ³•è¿è¡Œå¤±è´¥: ' + e.message); }
            btn.disabled = false; btn.textContent = 'è¿è¡Œæ³¢æŸæˆå½¢ç®—æ³•';
        }

        async function runDOA() {
            const btn = document.getElementById('btn-doa');
            btn.disabled = true; btn.textContent = 'è¿è¡Œä¸­...';
            try {
                const res = await axios.post(`${API_BASE}/algorithm/doa`, {
                    experiment_id: `exp_${Date.now()}`,
                    params: { element_count: 64, num_sources: 3, snapshot_length: 1024, method: 'MUSIC' }
                });
                const data = res.data.data;
                document.getElementById('doa-angles').textContent = data.estimated_angles?.map(a => a.toFixed(2) + 'Â°').join(', ') || '-';
                document.getElementById('doa-spectrum').textContent = data.spectrum?.length || '-';
                document.getElementById('doa-result').classList.remove('hidden');
                if (data.spectrum) {
                    const angles = data.spectrum.map((_, i) => (i * 180 / data.spectrum.length).toFixed(1));
                    doaResultChart.setOption({
                        title: { text: 'DOAç©ºé—´è°±', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: angles, name: 'è§’åº¦ (Â°)' },
                        yAxis: { type: 'value', name: 'è°±å€¼' },
                        series: [{ type: 'line', data: data.spectrum, smooth: true }]
                    });
                }
                alert('DOAä¼°è®¡ç®—æ³•è¿è¡ŒæˆåŠŸï¼');
            } catch (e) { alert('ç®—æ³•è¿è¡Œå¤±è´¥: ' + e.message); }
            btn.disabled = false; btn.textContent = 'è¿è¡ŒDOAä¼°è®¡ç®—æ³•';
        }

        function initCharts() {
            beamChart = echarts.init(document.getElementById('chart-beam'));
            sensorChart = echarts.init(document.getElementById('chart-sensor'));
            
            const pattern = [];
            for (let i = 0; i < 360; i++) pattern.push(Math.sin(i * 0.1) * 0.5 + 0.5 + Math.random() * 0.1);
            beamChart.setOption({
                title: { text: 'æ³¢æŸæ–¹å‘å›¾', left: 'center' },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: Array.from({length: 360}, (_, i) => i), name: 'è§’åº¦ (Â°)' },
                yAxis: { type: 'value', name: 'å¢ç›Š' },
                series: [{ type: 'line', data: pattern, smooth: true, areaStyle: { opacity: 0.3 } }]
            });

            sensorChart.setOption({
                title: { text: 'ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['æ¸©åº¦', 'æ¹¿åº¦', 'ç”µå‹'], top: 30 },
                xAxis: { type: 'category', data: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'] },
                yAxis: { type: 'value' },
                series: [
                    { name: 'æ¸©åº¦', type: 'line', data: [25, 26, 28, 30, 29, 27, 25] },
                    { name: 'æ¹¿åº¦', type: 'line', data: [60, 58, 55, 50, 52, 56, 59] },
                    { name: 'ç”µå‹', type: 'line', data: [220, 221, 219, 218, 220, 222, 221] }
                ]
            });

            beamResultChart = echarts.init(document.getElementById('chart-beam-result'));
            doaResultChart = echarts.init(document.getElementById('chart-doa-result'));
        }

        window.onload = function() {
            initCharts();
            fetchIRSStatus();
            fetchSensors();
        };
    </script>
</body>
</html>
